<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperNova Connector</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA y Favicon -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F0F8FF; }
        .app-bg { background-color: #F0F8FF; }
        .app-header { background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .active-tab { color: #00BFFF; border-bottom: 2px solid #00BFFF; }
        .tab-button { transition: color 0.2s, border-bottom 0.2s; }
        .console-output { min-height: 150px; max-height: 40vh; overflow-y: auto; white-space: pre-wrap; position: relative; }
        .console-loading { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(17, 24, 39, 0.7); display: flex; align-items: center; justify-content: center; color: #38BDF8; font-size: 1rem; border-radius: 0.5rem; }
        .notif-badge { background-color: #EF4444; color: white; font-size: 0.75rem; border-radius: 9999px; width: 1.25rem; height: 1.25rem; display: flex; align-items: center; justify-content: center; position: absolute; top: -0.25rem; right: -0.25rem; }
        .video-thumbnail { aspect-ratio: 16/9; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="app-bg">

    <!-- Modal para Notificaciones y Errores -->
    <div id="appModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-cyan-600">Notificaci√≥n</h3>
            <p id="modalMessage" class="text-gray-700 mb-4">Mensaje.</p>
            <button onclick="closeModal()" class="w-full bg-cyan-600 text-white p-2 rounded-lg hover:bg-cyan-700">Cerrar</button>
        </div>
    </div>

    <!-- Header (Barra de Navegaci√≥n Superior) -->
    <header class="app-header sticky top-0 z-30">
        <div class="max-w-4xl mx-auto p-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-cyan-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9.25 10.5M14.25 17L14.75 10.5M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                </svg>
                <span class="text-xl font-extrabold text-gray-900">SuperNova‚Ñ¢</span>
            </div>
            <!-- Navegaci√≥n de Escritorio -->
            <nav class="hidden md:flex space-x-6 text-gray-500 font-medium">
                <button id="tab-Videos" onclick="setActiveTab('Videos')" class="tab-button hover:text-cyan-600">Videos</button>
                <button id="tab-Feed" onclick="setActiveTab('Feed')" class="tab-button hover:text-cyan-600 active-tab">Feed</button>
                <button id="tab-MotorLab" onclick="setActiveTab('MotorLab')" class="tab-button hover:text-cyan-600">Motor Lab</button>
                <button id="tab-Profile" onclick="setActiveTab('Profile')" class="tab-button hover:text-cyan-600">Perfil</button>
            </nav>
            <div class="flex items-center space-x-3 relative">
                <!-- Bot√≥n de Notificaciones -->
                <button id="notifButton" onclick="setActiveTab('Notifications')" class="text-gray-500 hover:text-cyan-600 p-2 rounded-full transition relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 00-6-6h-4a6 6 0 00-6 6v3.158c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 01-6 0v-1m6 0H9" />
                    </svg>
                    <span id="notif-badge" class="notif-badge hidden"></span>
                </button>
                <!-- Bot√≥n de Perfil -->
                <button onclick="setActiveTab('Profile')" class="w-8 h-8 bg-cyan-200 rounded-full flex items-center justify-center text-cyan-700 font-bold text-sm border-2 border-cyan-500">
                    SN
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 pb-20 md:pb-8">
        <!-- ID de Usuario -->
        <p class="text-xs text-gray-500 mb-4 text-center">ID: <span id="currentUserId" class="font-mono text-cyan-600">Cargando...</span></p>
        <!-- Spinner de Carga Inicial -->
        <div id="loadingSpinner" class="text-center p-8">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-cyan-500 mx-auto"></div>
            <p class="text-gray-500 mt-2">Conectando a SuperNova...</p>
        </div>

        <!-- PESTA√ëA: VIDEOS -->
        <div id="content-Videos" class="tab-content hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Videos</h2>
                <button onclick="document.getElementById('videoUploadInput').click()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-cyan-700 transition">
                    Subir Video
                </button>
                <input type="file" id="videoUploadInput" accept="video/*" class="hidden" onchange="handleVideoUpload(event)">
            </div>
            <!-- Contenedor para la cuadr√≠cula de videos -->
            <div id="videos-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Los videos se cargar√°n aqu√≠ -->
            </div>
        </div>

        <!-- PESTA√ëA: FEED -->
        <div id="content-Feed" class="tab-content">
            <!-- √Årea de creaci√≥n de Post -->
            <div class="bg-white p-4 rounded-xl shadow-lg mb-6 border border-cyan-100">
                <textarea id="postInput" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 resize-none mb-2" placeholder="¬øQu√© pasa en tu mundo? (280)" maxlength="280" rows="3"></textarea>
                <div class="flex justify-between items-center text-sm text-gray-500 mb-3">
                    <span id="charCount">0/280</span>
                    <div class="flex space-x-2">
                        <input type="file" id="mediaUploadInput" accept="image/*,video/*" class="hidden" onchange="handleMediaSelection(event)">
                        <button onclick="document.getElementById('mediaUploadInput').click()" class="flex items-center space-x-1 text-cyan-600 hover:text-cyan-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 18m-2-2h2m-7 2h7m-7 0a2 2 0 11-4 0 2 2 0 014 0zM4 20h2a2 2 0 002-2v-2a2 2 0 00-2-2H4a2 2 0 00-2 2v2a2 2 0 002 2z" /></svg>
                            <span>Media</span>
                        </button>
                    </div>
                </div>
                <!-- Vista previa del archivo a subir -->
                <div id="mediaPreviewContainer" class="hidden mb-3"></div>
                <button id="postSubmitButton" onclick="handlePostSubmit()" class="w-full bg-cyan-600 text-white p-3 rounded-lg font-semibold hover:bg-cyan-700 disabled:opacity-50" disabled>Postear</button>
            </div>
            <!-- Contenedor de Posts -->
            <div id="postsContainer" class="space-y-6">
                <!-- Los posts de Firebase se cargar√°n aqu√≠ -->
            </div>
        </div>

        <!-- PESTA√ëA: MOTOR LAB -->
        <div id="content-MotorLab" class="tab-content hidden">
            <div class="w-full bg-gray-900 rounded-xl shadow-2xl p-6 md:p-8 border border-cyan-700/50">
                <header class="mb-6 text-center">
                    <h2 class="text-3xl font-extrabold text-cyan-400 mb-1 tracking-wider">
                        Motor Lab Consola
                    </h2>
                    <p class="text-gray-400 text-sm">
                        Asistente de Diagn√≥stico con IA (Pregunte sobre DTCs o mantenimiento).
                    </p>
                </header>
                <div class="space-y-4">
                    <div id="outputLog" class="console-output bg-gray-900 p-4 rounded-lg border border-gray-700/60 transition duration-300 hover:border-cyan-500/50">
                        <!-- Indicador de Carga de IA -->
                        <div id="consoleLoading" class="console-loading hidden">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-cyan-400 mr-3"></div>
                            <span>SuperNova Analizando...</span>
                        </div>
                        <p class="text-cyan-500 font-mono text-sm">>$ Ingrese un comando en el campo inferior para interactuar con el Motor Lab.</p>
                        <p class="text-gray-500 font-mono text-xs">>$ Pruebe con 'Qu√© significa P0420?' o 'C√≥mo cambiar el aceite de un Honda Civic 2010?'</p>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            type="text"
                            id="commandInput"
                            placeholder="Escribe tu consulta de diagn√≥stico o mantenimiento aqu√≠..."
                            class="flex-grow p-3 rounded-lg bg-gray-700 text-gray-100 placeholder-gray-400 border border-gray-700 focus:border-cyan-500 focus:ring-cyan-500 focus:ring-1 transition duration-200 shadow-md"
                        />
                        <button
                            id="executeCommandButton"
                            onclick="motorLabLogic.processCommand()"
                            class="bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-[1.02] shadow-lg shadow-cyan-900/50 active:shadow-none active:scale-[0.98]"
                        >
                            Ejecutar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PESTA√ëA: PERFIL -->
        <div id="content-Profile" class="tab-content hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg text-center">
                <div class="w-20 h-20 bg-cyan-200 rounded-full mx-auto mb-3 flex items-center justify-center text-2xl font-bold text-cyan-700 border-4 border-cyan-500">SN</div>
                <h3 class="text-xl font-bold" id="profileUsername">User-XXXX</h3>
                <p class="text-sm text-gray-500" id="profileBio">Explorador del cosmos automotriz</p>
                <div class="flex justify-center space-x-6 mt-4 text-sm">
                    <div><strong id="profileFollowers">0</strong> Seguidores</div>
                    <div><strong id="profileFollowing">0</strong> Siguiendo</div>
                    <div><strong id="userCoins">0</strong> Monedas</div>
                </div>
                <button onclick="buyCoins(100)" class="mt-4 bg-cyan-600 text-white px-6 py-2 rounded-lg hover:bg-cyan-700 transition">Comprar 100 Monedas</button>
                <p id="vipBadge" class="hidden mt-3 text-cyan-600 font-bold">VIP Tester (Acceso Anticipado)</p>
            </div>
        </div>

        <!-- PESTA√ëA: NOTIFICACIONES -->
        <div id="content-Notifications" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">Notificaciones</h2>
            <div id="notificationsContainer" class="space-y-3">
                <!-- Las notificaciones de Firebase se cargar√°n aqu√≠ -->
            </div>
        </div>
    </main>

    <!-- Footer Mobile (Barra de Navegaci√≥n Inferior) -->
    <footer class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 z-40 p-2 shadow-xl">
        <nav class="flex justify-around text-gray-500">
            <button onclick="setActiveTab('Videos')" class="flex flex-col items-center tab-button-mobile" id="tab-Videos-mobile">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.55 3.55a.5.5 0 010 .9L15 18M7 6v12M3 10l4.55 3.55a.5.5 0 000 .9L3 18m12-8H7" /></svg>
                <span class="text-xs">Videos</span>
            </button>
            <button onclick="setActiveTab('Feed')" class="flex flex-col items-center tab-button-mobile active-tab" id="tab-Feed-mobile">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20a2 2 0 01-2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v15zm-9-10h4m-4 4h4m-4 4h4" /></svg>
                <span class="text-xs">Feed</span>
            </button>
            <button onclick="setActiveTab('MotorLab')" class="flex flex-col items-center tab-button-mobile" id="tab-MotorLab-mobile">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2a10 10 0 100 20 10 10 0 000-20zm0 18a8 8 0 110-16 8 8 0 010 16zm-1-8a1 1 0 11-2 0 1 1 0 012 0zm3 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg>
                <span class="text-xs">Motor Lab</span>
            </button>
            <button onclick="setActiveTab('Profile')" class="flex flex-col items-center tab-button-mobile" id="tab-Profile-mobile">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                <span class="text-xs">Perfil</span>
            </button>
        </nav>
    </footer>

    <!-- Footer Desktop -->
    <footer class="hidden md:block text-center text-xs text-gray-500 py-4 mt-10">
        ¬© 2025 Eduardo Luzardo. Todos los derechos reservados. SuperNova‚Ñ¢ Connector.
    </footer>

    <script type="module">
        // --- IMPORTS DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, doc, updateDoc, increment, 
            onSnapshot, query, orderBy, serverTimestamp, setDoc, getDoc, 
            where, limit 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytesResumable, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURACI√ìN DE FIREBASE (TU CONFIG) ---
        // ¬°No pegues tu clave aqu√≠ si el repositorio es p√∫blico!
        // Esta clave debe tener restricciones de "Sitios web" en Google Cloud
        const firebaseConfig = {
          apiKey: "TU_API_KEY_DE_FIREBASE", // Reemplaza con tu clave NUEVA y RESTRINGIDA
          authDomain: "supernova-connector.firebaseapp.com",
          projectId: "supernova-connector",
          storageBucket: "supernova-connector.firebasestorage.app", // CORRECCI√ìN REALIZADA
          messagingSenderId: "283998519995",
          appId: "1:283998519995:web:1ce19489d3b8414ca81f9a"
        };

        // --- CONSTANTES DE LA APP ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let userId = 'guest'; // ID temporal
        const appId = 'supernova'; // ID de tu app
        let unsubscribeUser, unsubscribeFeed, unsubscribeVideos, unsubscribeNotifs; // Para limpiar listeners

        // --- CONSTANTES DE GEMINI API ---
        // ¬°No pegues tu clave aqu√≠!
        // Esta clave tambi√©n debe tener la restricci√≥n de "Sitios web"
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = "TU_API_KEY_DE_GEMINI"; // Reemplaza con tu clave NUEVA y RESTRINGIDA
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`; // CORRECCI√ìN URL
        const SYSTEM_INSTRUCTION = "Act√∫a como un asistente experto de laboratorio automotriz y diagn√≥stico llamado SuperNova. Proporciona respuestas concisas, claras y t√©cnicamente precisas a comandos y consultas sobre veh√≠culos. Utiliza la herramienta de b√∫squeda de Google para encontrar informaci√≥n actualizada, especialmente para c√≥digos de diagn√≥stico de fallas (DTC) o modelos de autom√≥viles espec√≠ficos. Formatea la informaci√≥n t√©cnica compleja en p√°rrafos cortos y legibles.";


        // --- L√ìGICA DEL MODAL ---
        window.closeModal = () => document.getElementById('appModal').classList.add('hidden');
        const openModal = (title, msg) => {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = msg; // innerHTML para permitir barras de progreso
            document.getElementById('appModal').classList.remove('hidden');
        };
        // Modal de progreso para subidas
        const showUploadProgress = (progress) => {
            openModal('Subiendo Media...', `
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="bg-cyan-600 h-2.5 rounded-full" style="width: ${progress.toFixed(0)}%"></div>
                </div>
                <p class="text-center text-sm font-medium mt-2">${progress.toFixed(0)}%</p>
            `);
        };

        // --- AUTENTICACI√ìN Y ARRANQUE ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('currentUserId').textContent = userId;
                await ensureUserDoc(userId); // Asegura que el doc del usuario exista
                initAllListeners(); // Inicia todos los listeners de Firebase
            } else {
                signInAnonymously(auth); // Si no hay usuario, loguea uno an√≥nimo
            }
            document.getElementById('loadingSpinner').classList.add('hidden');
            setActiveTab('Feed'); // Pesta√±a por defecto
        });

        // Asegura que cada usuario tenga un documento en Firestore
        async function ensureUserDoc(uid) {
            const userRef = doc(db, `artifacts/${appId}/users/${uid}`);
            const snap = await getDoc(userRef);
            if (!snap.exists()) {
                await setDoc(userRef, {
                    username: `User-${uid.substring(0, 4)}`,
                    coins: 50,
                    isVIP: false,
                    bio: "Explorador del cosmos automotriz",
                    timestamp: serverTimestamp()
                });
            }
        }

        // --- L√ìGICA DE PESTA√ëAS ---
        window.activeTab = 'Feed';
        window.setActiveTab = (tab) => {
            window.activeTab = tab;
            // Oculta todo el contenido
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Muestra el contenido de la pesta√±a activa
            const contentEl = document.getElementById(`content-${tab}`);
            if(contentEl) contentEl.classList.remove('hidden');
            
            // Actualiza los botones de navegaci√≥n (m√≥vil y escritorio)
            document.querySelectorAll('.tab-button, .tab-button-mobile').forEach(b => b.classList.remove('active-tab'));
            [`tab-${tab}`, `tab-${tab}-mobile`].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('active-tab');
            });
            
            // Si la pesta√±a es MotorLab, inicializa su l√≥gica
            if (tab === 'MotorLab') motorLabLogic.init();
            // Si la pesta√±a es Notificaciones, marca como le√≠das
            if (tab === 'Notifications') markNotificationsAsRead();
        };

        // --- L√ìGICA DEL FEED (Posts & Media) ---

        // Contador de caracteres para el post
        function setupCharCounter() {
            const input = document.getElementById('postInput');
            const counter = document.getElementById('charCount');
            const btn = document.getElementById('postSubmitButton');
            const updateButton = () => {
                const len = input.value.trim().length;
                counter.textContent = `${len}/280`;
                // El bot√≥n se activa si hay texto O un archivo seleccionado
                btn.disabled = (len === 0 && !mediaFile);
            };
            input.addEventListener('input', updateButton);
            updateButton();
        }

        let mediaFile = null; // Archivo (imagen o video) a subir
        
        // Maneja la selecci√≥n de un archivo (imagen o video)
        window.handleMediaSelection = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // L√≠mite de 20MB para posts del feed
            if (file.size > 20 * 1024 * 1024) {
                openModal('Error', 'Archivo demasiado grande (m√°x 20MB para el feed)');
                return;
            }
            mediaFile = file;
            
            // Muestra la vista previa
            const preview = document.getElementById('mediaPreviewContainer');
            preview.innerHTML = `
                <div class="flex items-center justify-between p-2 bg-gray-100 rounded-lg">
                    <span class="text-sm truncate">${file.name} (${(file.size / 1024 / 1024).toFixed(1)}MB)</span>
                    <button onclick="clearMediaSelection()" class="text-red-500 font-bold ml-2">X</button>
                </div>
            `;
            preview.classList.remove('hidden');
            document.getElementById('postSubmitButton').disabled = false; // Habilita el bot√≥n
        };

        // Limpia la selecci√≥n de media
        window.clearMediaSelection = () => {
            mediaFile = null;
            document.getElementById('mediaPreviewContainer').classList.add('hidden');
            document.getElementById('mediaUploadInput').value = '';
            // Re-eval√∫a si el bot√≥n de postear debe estar deshabilitado
            setupCharCounter();
        };
        // Hacer global para el bot√≥n 'X'
        window.clearMediaSelection = clearMediaSelection;

        /**
         * L√ìGICA DE SUBIDA Y PUBLICACI√ìN (ASINCRON√çA CORREGIDA)
         * Esta es la funci√≥n m√°s importante para tu problema.
         */
        window.handlePostSubmit = async () => {
            const content = document.getElementById('postInput').value.trim();
            // No se puede postear si no hay ni texto ni archivo
            if (!content && !mediaFile) return;

            const postButton = document.getElementById('postSubmitButton');
            postButton.disabled = true;
            postButton.textContent = "Posteando...";

            let mediaURL = null;
            let isVideo = false;
            let uploadError = false;

            // --- PASO 1: Subir el archivo (si existe) ---
            if (mediaFile) {
                const filePath = `feed/${userId}/${Date.now()}_${mediaFile.name}`;
                const mediaRef = ref(storage, filePath);
                const task = uploadBytesResumable(mediaRef, mediaFile);

                // Determina si es video por el tipo de archivo
                isVideo = mediaFile.type.startsWith('video/');

                // Usamos 'await' en la tarea de subida
                try {
                    await new Promise((resolve, reject) => {
                        task.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                showUploadProgress(progress);
                            },
                            (error) => {
                                reject(error); // Error en la subida
                            },
                            async () => {
                                // Subida completada
                                mediaURL = await getDownloadURL(task.snapshot.ref);
                                resolve(); // Resuelve la promesa
                            }
                        );
                    });
                } catch (error) {
                    console.error("Error al subir archivo a Storage:", error);
                    openModal('Error de Subida', `No se pudo subir el archivo: ${error.message}`);
                    uploadError = true;
                }
            }
            
            closeModal(); // Cierra el modal de progreso

            // --- PASO 2: Guardar en Firestore (SOLO si la subida fue exitosa o no hab√≠a archivo) ---
            if (!uploadError) {
                try {
                    await addDoc(collection(db, `artifacts/${appId}/posts`), {
                        content: content || (isVideo ? "Nuevo video" : "Nueva imagen"), // Contenido por defecto si est√° vac√≠o
                        mediaURL: mediaURL, // Ser√° 'null' si no se subi√≥ archivo
                        isVideo: isVideo,   // Flag booleano
                        userId: userId,
                        username: `User-${userId.substring(0, 4)}`,
                        likes: 0,
                        comments: 0,
                        likedBy: [], // Array para manejar 'me gusta' √∫nicos
                        timestamp: serverTimestamp()
                    });

                    // Limpiar el formulario
                    document.getElementById('postInput').value = '';
                    clearMediaSelection();
                    setupCharCounter();

                } catch (error) {
                    console.error("Error al guardar en Firestore:", error);
                    openModal('Error de Post', `No se pudo guardar la publicaci√≥n: ${error.message}`);
                }
            }

            // Reactivar el bot√≥n
            postButton.disabled = false;
            postButton.textContent = "Postear";
        };


        // --- L√ìGICA DE LA PESTA√ëA DE VIDEOS (ASINCRON√çA CORREGIDA) ---
        window.handleVideoUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // L√≠mite de 100MB para videos
            if (file.size > 100 * 1024 * 1024) {
                openModal('Error', 'Video demasiado grande (m√°x 100MB)');
                return;
            }

            const filePath = `videos/${userId}/${Date.now()}_${file.name}`;
            const videoRef = ref(storage, filePath);
            const task = uploadBytesResumable(videoRef, file);

            try {
                // Mismo patr√≥n async de "handlePostSubmit"
                await new Promise((resolve, reject) => {
                    task.on('state_changed',
                        (snapshot) => {
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            showUploadProgress(progress);
                        },
                        (error) => {
                            reject(error);
                        },
                        async () => {
                            // Subida completada, obtener URL
                            const url = await getDownloadURL(task.snapshot.ref);
                            
                            // Guardar en Firestore
                            await addDoc(collection(db, `artifacts/${appId}/posts`), {
                                content: file.name.replace(/_/g, ' ').replace(/\.[^/.]+$/, ""), // T√≠tulo por defecto
                                mediaURL: url,
                                isVideo: true, // ¬°Flag importante!
                                userId: userId,
                                username: `User-${userId.substring(0, 4)}`,
                                likes: 0,
                                comments: 0,
                                likedBy: [],
                                timestamp: serverTimestamp()
                            });
                            resolve(); // Resuelve la promesa
                        }
                    );
                });
                closeModal(); // Cierra el modal de progreso
                openModal('√âxito', '¬°Video subido y publicado!');

            } catch (error) {
                console.error("Error al subir video:", error);
                closeModal();
                openModal('Error de Subida', `Video fall√≥: ${error.message}`);
            } finally {
                // Limpiar el input de archivo
                e.target.value = '';
            }
        };


        // --- RENDERIZADO DE POSTS Y VIDEOS ---
        
        // Renderiza un post individual (usado por el Feed)
        function renderPost(p) {
            // L√≥gica de renderizado basada en el flag 'p.isVideo'
            const mediaHtml = p.mediaURL 
                ? (p.isVideo 
                    ? `<video src="${p.mediaURL}" controls class="w-full mt-3 rounded-xl bg-black"></video>` 
                    : `<img src="${p.mediaURL}" class="w-full mt-3 rounded-xl">`) 
                : '';
            
            // Revisa si el usuario actual ya dio 'like'
            const userLiked = p.likedBy && p.likedBy.includes(userId);
            const likeButtonClass = userLiked ? 'text-cyan-500' : 'text-gray-500 hover:text-cyan-500';

            return `
                <div class="bg-white p-4 rounded-xl shadow border border-gray-100">
                    <!-- Encabezado del Post -->
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-8 h-8 bg-cyan-200 rounded-full flex items-center justify-center text-cyan-700 font-bold text-sm">SN</div>
                        <div>
                            <p class="font-semibold">${p.username}</p>
                            <p class="text-xs text-gray-500">${new Date(p.timestamp?.toDate ? p.timestamp.toDate() : Date.now()).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <!-- Contenido del Post -->
                    <p class="text-gray-800">${p.content}</p>
                    ${mediaHtml}
                    
                    <!-- Barra de Interacci√≥n -->
                    <div class="flex justify-between items-center mt-4 pt-3 border-t border-gray-100 text-sm">
                        <button onclick="toggleLikePost('${p.id}')" class="${likeButtonClass} flex items-center space-x-1 transition">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.432a2 2 0 00.556 1.34L10 19l4.444-3.9a2 2 0 00.556-1.34V10.333l1.874-3.748a.5.5 0 00-.233-.64L16 5l-4-4.596-2.5 2.5a.5.5 0 00-.09.308L9 5.385l-1.884-1.884a.5.5 0 00-.707 0L4.316 6.584z" /></svg>
                            <span>${p.likes || 0}</span>
                        </button>
                        <span class="text-gray-500">${p.comments || 0} comentarios</span>
                    </div>

                    <!-- Secci√≥n de Comentarios (Re-integrada) -->
                    <div class="mt-4 pt-3 border-t border-gray-100 space-y-3">
                        <div id="comments-container-${p.id}" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                            <!-- Los comentarios se cargar√°n aqu√≠ -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="comment-input-${p.id}" placeholder="Escribe tu respuesta..." class="flex-grow p-2 text-sm border border-gray-300 rounded-lg focus:ring-cyan-500">
                            <button onclick="handleCommentSubmit('${p.id}')" class="bg-cyan-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-cyan-600 transition">Enviar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Renderiza una miniatura de video (usado por la pesta√±a Videos)
        function renderVideoThumbnail(v) {
            return `
                <div onclick="playVideo('${v.mediaURL}', '${v.content}', '${v.id}')" class="bg-white rounded-xl shadow-lg overflow-hidden transition transform hover:scale-[1.02] cursor-pointer">
                    <div class="bg-gray-900 video-thumbnail rounded-t-xl overflow-hidden">
                        <!-- Usamos <video> para la miniatura, es m√°s din√°mico -->
                        <video src="${v.mediaURL}#t=0.5" class="w-full h-full object-cover" muted preload="metadata"></video>
                    </div>
                    <div class="p-3">
                        <h3 class="font-semibold text-gray-800 truncate">${v.content}</h3>
                        <p class="text-sm text-gray-500 mt-1">${v.username} | ${new Date(v.timestamp?.toDate()).toLocaleDateString()}</p>
                    </div>
                </div>
            `;
        }

        // Funci√≥n 'playVideo' (placeholder por ahora)
        window.playVideo = (url, title, id) => {
            // Aqu√≠ podr√≠as abrir un modal de reproducci√≥n de video
            openModal(`Reproduciendo: ${title}`, `El video (ID: ${id}) se reproducir√≠a aqu√≠. URL: ${url}`);
        }

        // --- L√ìGICA DE INTERACCI√ìN (Likes & Comentarios) ---

        // L√≥gica de 'Me Gusta' (Like/Unlike)
        window.toggleLikePost = async (postId) => {
            const postRef = doc(db, `artifacts/${appId}/posts/${postId}`);
            const postSnap = await getDoc(postRef);
            if (!postSnap.exists()) return;

            const postData = postSnap.data();
            const likedBy = postData.likedBy || [];
            
            // Si el usuario ya dio like, se lo quitamos (Unlike)
            if (likedBy.includes(userId)) {
                await updateDoc(postRef, { 
                    likes: increment(-1),
                    likedBy: likedBy.filter(uid => uid !== userId) // Quita al usuario del array
                });
            } else {
                // Si el usuario no ha dado like, lo agregamos (Like)
                await updateDoc(postRef, { 
                    likes: increment(1),
                    likedBy: [...likedBy, userId] // A√±ade al usuario al array
                });
                // Enviar notificaci√≥n (¬°excepto si es nuestro propio post!)
                if (postData.userId !== userId) {
                    sendNotification(postData.userId, 'like', postId, `A @${postData.username} le gust√≥ tu post.`);
                }
            }
        };

        // Enviar un comentario (Re-integrado)
        window.handleCommentSubmit = async (postId) => {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;

            const postRef = doc(db, `artifacts/${appId}/posts/${postId}`);
            const commentsRef = collection(postRef, "comments");

            try {
                // 1. A√±adir el comentario a la sub-colecci√≥n
                await addDoc(commentsRef, {
                    userId: userId,
                    username: `User-${userId.substring(0, 4)}`,
                    content: content,
                    timestamp: serverTimestamp()
                });
                // 2. Incrementar el contador en el post principal
                await updateDoc(postRef, { comments: increment(1) });
                
                input.value = ''; // Limpiar
            } catch (error) {
                console.error("Error al comentar: ", error);
                openModal('Error', 'No se pudo guardar tu comentario.');
            }
        };

        // --- L√ìGICA DE PERFIL Y NOTIFICACIONES (Tus nuevas pesta√±as) ---

        // Compra simulada de monedas
        window.buyCoins = async (amount) => {
            const userRef = doc(db, `artifacts/${appId}/users/${userId}`);
            await updateDoc(userRef, { coins: increment(amount) });
            openModal('¬°√âxito!', `¬°Has comprado ${amount} monedas!`);
        };

        // Enviar una notificaci√≥n a un usuario
        async function sendNotification(targetUserId, type, postId, message) {
            if (!targetUserId || targetUserId === userId) return; // No notificarse a s√≠ mismo
            
            const notifRef = collection(db, `artifacts/${appId}/users/${targetUserId}/notifications`);
            await addDoc(notifRef, {
                fromUser: `User-${userId.substring(0,4)}`,
                type: type, // 'like', 'comment'
                postId: postId,
                message: message,
                isRead: false,
                timestamp: serverTimestamp()
            });
        }
        
        // Marcar notificaciones como le√≠das al abrir la pesta√±a
        async function markNotificationsAsRead() {
            // Esta es una operaci√≥n de "escritura por lotes" (batch write),
            // pero por simplicidad, solo ocultaremos la insignia.
            const badge = document.getElementById('notif-badge');
            badge.textContent = '';
            badge.classList.add('hidden');
            
            // TODO: En un futuro, deber√≠as hacer un batch write
            // para actualizar el flag 'isRead' en Firestore.
        }


        // --- INICIALIZACI√ìN DE LISTENERS (TIEMPO REAL) ---
        function initAllListeners() {
            // Limpiar listeners antiguos para evitar duplicados
            if (unsubscribeUser) unsubscribeUser();
            if (unsubscribeFeed) unsubscribeFeed();
            if (unsubscribeVideos) unsubscribeVideos();
            if (unsubscribeNotifs) unsubscribeNotifs();

            // 1. Listener para el Perfil del Usuario
            const userRef = doc(db, `artifacts/${appId}/users/${userId}`);
            unsubscribeUser = onSnapshot(userRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    document.getElementById('profileUsername').textContent = data.username;
                    document.getElementById('profileBio').textContent = data.bio;
                    document.getElementById('userCoins').textContent = data.coins || 0;
                    if (data.isVIP) {
                        document.getElementById('vipBadge').classList.remove('hidden');
                    }
                }
            });

            // 2. Listener para el Feed (Pesta√±a "Feed")
            const feedQuery = query(collection(db, `artifacts/${appId}/posts`), orderBy("timestamp", "desc"), limit(50));
            unsubscribeFeed = onSnapshot(feedQuery, (snap) => {
                const container = document.getElementById('postsContainer');
                container.innerHTML = '';
                if (snap.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-8">Sin posts a√∫n. ¬°S√© el primero!</p>';
                    return;
                }
                snap.forEach(doc => {
                    const p = { id: doc.id, ...doc.data() };
                    const el = document.createElement('div');
                    el.innerHTML = renderPost(p);
                    container.appendChild(el.firstChild);
                    // Inicia el listener de comentarios para CADA post
                    initRealtimeComments(p.id);
                });
            }, (error) => {
                console.error("Error en listener de Feed: ", error);
                document.getElementById('postsContainer').innerHTML = `<p class="text-red-500 text-center">Error al cargar el feed.</p>`;
            });

            // 3. Listener para la cuadr√≠cula de Videos (Pesta√±a "Videos")
            const videosQuery = query(collection(db, `artifacts/${appId}/posts`), where("isVideo", "==", true), orderBy("timestamp", "desc"), limit(21));
            unsubscribeVideos = onSnapshot(videosQuery, (snap) => {
                const container = document.getElementById('videos-grid');
                container.innerHTML = '';
                 if (snap.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-8 col-span-3">A√∫n no se han subido videos.</p>';
                    return;
                }
                snap.forEach(doc => {
                    const v = { id: doc.id, ...doc.data() };
                    const el = document.createElement('div');
                    el.innerHTML = renderVideoThumbnail(v);
                    container.appendChild(el.firstChild);
                });
            }, (error) => {
                console.error("Error en listener de Videos: ", error);
                document.getElementById('videos-grid').innerHTML = `<p class="text-red-500 text-center">Error al cargar videos.</p>`;
            });

            // 4. Listener para Notificaciones
            const notifQuery = query(collection(db, `artifacts/${appId}/users/${userId}/notifications`), orderBy("timestamp", "desc"), limit(20));
            unsubscribeNotifs = onSnapshot(notifQuery, (snap) => {
                const container = document.getElementById('notificationsContainer');
                container.innerHTML = '';
                let unreadCount = 0;
                if (snap.empty) {
                    container.innerHTML = '<p class="text-center text-gray-500 p-8">No tienes notificaciones.</p>';
                    return;
                }
                snap.forEach(doc => {
                    const n = doc.data();
                    if (!n.isRead) unreadCount++;
                    const icon = n.type === 'like' ? '‚ù§Ô∏è' : 'üí¨';
                    const el = document.createElement('div');
                    el.className = `p-3 rounded-lg ${n.isRead ? 'bg-white' : 'bg-cyan-50 border border-cyan-200'}`;
                    el.innerHTML = `
                        <p>${icon} ${n.message}</p>
                        <p class="text-xs text-gray-500">${new Date(n.timestamp?.toDate()).toLocaleString()}</p>
                    `;
                    container.appendChild(el);
                });
                // Actualizar la insignia de notificaci√≥n
                const badge = document.getElementById('notif-badge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error en listener de Notificaciones: ", error);
            });
        }

        // Listener para los comentarios de un post espec√≠fico
        function initRealtimeComments(postId) {
            const commentsRef = collection(db, `artifacts/${appId}/posts/${postId}/comments`);
            const q = query(commentsRef, orderBy("timestamp", "asc"), limit(20));
            
            // Este onSnapshot se auto-limpia si el post desaparece
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById(`comments-container-${postId}`);
                if (!container) return; // El post ya no est√° en el DOM

                container.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentHtml = `
                        <div class="p-2 bg-gray-50 rounded-lg border border-gray-100 text-sm">
                            <span class="font-semibold text-cyan-600">${comment.username}:</span> 
                            <span class="text-gray-700">${comment.content}</span>
                        </div>
                    `;
                    container.appendChild(document.createRange().createContextualFragment(commentHtml));
                });
            }, (error) => {
                console.error(`Error en listener de Comentarios (Post ${postId}): `, error);
            });
        }

        // --- L√ìGICA DE MOTOR LAB (IA) ---
        const motorLabLogic = (function() {
            let inputElement, outputElement, loadingElement, executeButton;

            function appendToLog(text, isUser = false) {
                const entry = document.createElement('p');
                entry.classList.add('font-mono', 'text-sm', 'mb-1');
                if (isUser) {
                    entry.innerHTML = `&gt;$ <span class="text-green-400">${text}</span>`;
                } else {
                    entry.innerHTML = `<span class="text-cyan-500">[MOTOR]</span>: ${text}`;
                }
                outputElement.appendChild(entry);
                outputElement.scrollTop = outputElement.scrollHeight;
            }
            
            // Funci√≥n de reintento (Exponential Backoff)
            async function fetchWithBackoff(url, options, maxRetries = 4) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            if (response.status === 429 && i < maxRetries - 1) { // Too Many Requests
                                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response; // √âxito
                    } catch (error) {
                        if (i === maxRetries - 1) throw error; 
                    }
                }
            }

            async function processCommand() {
                const command = inputElement.value.trim();
                if (command === "") return;

                appendToLog(command, true);
                inputElement.value = '';

                loadingElement.classList.remove('hidden');
                inputElement.disabled = true;
                executeButton.disabled = true;

                const payload = {
                    contents: [{ parts: [{ text: command }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: SYSTEM_INSTRUCTION }] },
                };

                try {
                    const response = await fetchWithBackoff(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.error) {
                        throw new Error(result.error.message);
                    }

                    const candidate = result.candidates?.[0];
                    let responseText = "Error: No se pudo obtener una respuesta v√°lida del modelo.";
                    let sourcesHtml = '';

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        responseText = candidate.content.parts[0].text;
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                sourcesHtml = '<p class="text-xs text-gray-500 font-sans mt-2 mb-1">Referencias de Google:</p><ul class="list-disc list-inside text-xs text-gray-400 font-sans">';
                                sources.slice(0, 3).forEach(source => {
                                    sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="hover:text-cyan-400 truncate">${source.title}</a></li>`;
                                });
                                sourcesHtml += '</ul>';
                            }
                        }
                    } 
                    
                    appendToLog(responseText, false);
                    if (sourcesHtml) {
                        const sourcesEl = document.createElement('div');
                        sourcesEl.innerHTML = sourcesHtml;
                        outputElement.appendChild(sourcesEl);
                    }

                } catch (error) {                 
                    console.error("Error al llamar a Gemini API:", error);
                    let userErrorMessage = `Error de conexi√≥n o timeout. Intente de nuevo.`;
                    if (error.message.includes("4CSS")) {
                        userErrorMessage = "Error de API (403): Acceso prohibido. Revisa las restricciones de tu API Key (Sitios web).";
                    } else if (error.message.includes("400")) {
                        userErrorMessage = "Error de API (400): Solicitud incorrecta. Revisa el modelo de IA o la API Key.";
                    }
                    appendToLog(userErrorMessage, false);
                    
                } finally {
                    loadingElement.classList.add('hidden');
                    inputElement.disabled = false;
                    executeButton.disabled = false;
                    inputElement.focus();
                }
            }

            function handleKeyPress(event) {
                if (event.key === 'Enter') processCommand();
            }

            function init() {
                inputElement = document.getElementById('commandInput');
                outputElement = document.getElementById('outputLog');
                loadingElement = document.getElementById('consoleLoading');
                executeButton = document.getElementById('executeCommandButton');
                if(inputElement) inputElement.onkeydown = handleKeyPress;
            }

            return { init, processCommand, handleKeyPress, appendToLog };
        })();

        // Exponer funciones globales
        window.motorLabLogic = motorLabLogic;
        // window.handleKeyPress = motorLabLogic.handleKeyPress; // Esta l√≠nea ya no es necesaria
        window.toggleLikePost = toggleLikePost;
        window.handleCommentSubmit = handleCommentSubmit;
        window.buyCoins = buyCoins;
        window.playVideo = playVideo; // Exponer la funci√≥n de reproducir video

        // --- ARRANQUE INICIAL ---
        setupCharCounter(); // Configura el contador de caracteres del feed

    </script>
</body>
</html>
